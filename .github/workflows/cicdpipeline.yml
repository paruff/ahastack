name: CI/CD Pipeline

# All CI/CD processes run in GitHub Actions, not locally.
# Local Make targets are for development convenience only.
# Code quality analysis runs via SonarCloud integration below.

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0' # Weekly security scan

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose
        run: docker compose config --quiet

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_file: .yamllint

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting tools
        run: |
          pip install flake8 pylint black isort yamllint

      - name: Run flake8
        run: find tests -name "*.py" -exec flake8 {} +
        continue-on-error: true

      - name: Run pylint
        run: find tests -name "*.py" -exec pylint {} +
        continue-on-error: true

      - name: Check code formatting with black
        run: find tests -name "*.py" -exec black --check {} +

      - name: Check import sorting
        run: find tests -name "*.py" -exec isort --check {} +

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Scan Docker images
        run: |
          docker pull ghcr.io/home-assistant/home-assistant:2024.1
          docker pull postgres:16-alpine
          docker pull eclipse-mosquitto:2.0
          
          trivy image --severity HIGH,CRITICAL ghcr.io/home-assistant/home-assistant:2024.1
          trivy image --severity HIGH,CRITICAL postgres:16-alpine
          trivy image --severity HIGH,CRITICAL eclipse-mosquitto:2.0

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SBOM Generation
        uses: anchore/sbom-action@v0
        with:
          path: ./
          format: cyclonedx-json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: ./sbom-*.json

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov pytest-asyncio paho-mqtt psycopg2-binary

      - name: Run unit tests
        run: |
          python -m pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: unit-tests

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "POSTGRES_PASSWORD=testpassword" >> .env
          echo "GRAFANA_PASSWORD=testpassword" >> .env
          echo "VSCODE_PASSWORD=testpassword" >> .env

      - name: Start services
        run: |
          docker compose up -d postgres mosquitto
          sleep 10

      - name: Wait for services to be healthy
        run: |
          timeout 120 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'

      - name: Run integration tests
        run: |
          docker compose run --rm test_runner bash -c "
            pip install pytest pytest-asyncio requests paho-mqtt psycopg2-binary
            python -m pytest /tests/integration/ -v --tb=short
          "

      - name: Collect logs on failure
        if: failure()
        run: docker compose logs > integration-test-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: integration-test-logs.txt

      - name: Cleanup
        if: always()
        run: docker compose down -v

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "POSTGRES_PASSWORD=testpassword" >> .env
          echo "GRAFANA_PASSWORD=testpassword" >> .env
          echo "VSCODE_PASSWORD=testpassword" >> .env

      - name: Start all services
        run: |
          docker compose up -d
          sleep 30

      - name: Wait for all services
        run: |
          timeout 300 bash -c 'until [ $(docker compose ps | grep -c "healthy") -ge 5 ]; do sleep 5; done'

      - name: Run E2E BDD tests
        run: |
          docker compose run --rm test_runner bash -c "
            pip install pytest pytest-bdd pytest-asyncio requests
            python -m pytest /tests/e2e/ -v --tb=short
          "

      - name: Generate test report
        if: always()
        run: docker compose logs > e2e-test-logs.txt

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            e2e-test-logs.txt
            reports/

      - name: Cleanup
        if: always()
        run: docker compose down -v

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: lint
    # Make this optional for forks without SONAR_TOKEN
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        # Skip for forks as they won't have SONAR_TOKEN secret
        if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=your-org_home-automation
            -Dsonar.organization=your-org
            -Dsonar.sources=.
            -Dsonar.exclusions=tests/**,reports/**
            -Dsonar.tests=tests/
            -Dsonar.python.coverage.reportPaths=coverage.xml

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: [security-scan, supply-chain, e2e-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/platform:latest
            ghcr.io/${{ github.repository }}/platform:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://homeassistant.yourdomain.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /opt/home-automation
            git pull origin main
            docker compose pull
            docker compose up -d
            docker compose ps

      - name: Health check
        run: |
          sleep 30
          curl -f https://homeassistant.yourdomain.com || exit 1

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'Deployment successful! :rocket:'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'Deployment failed! :x:'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
